# ===========================================
# QualyIT Production Docker Compose
# Para uso con Coolify u otro orquestador
# ===========================================

version: '3.8'

services:
  # ===========================================
  # PostgreSQL Database
  # ===========================================
  postgres:
    image: postgres:16-alpine
    container_name: qualyit-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-qualyit}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-qualyit}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-qualyit} -d ${POSTGRES_DB:-qualyit}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - qualyit-network

  # ===========================================
  # Next.js Application
  # ===========================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
        - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-QualyIT}
    container_name: qualyit-web
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # Database
      DATABASE_URL: postgresql://${POSTGRES_USER:-qualyit}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-qualyit}

      # Clerk Authentication
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      CLERK_WEBHOOK_SECRET: ${CLERK_WEBHOOK_SECRET}

      # Clerk URLs
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: /sign-in
      NEXT_PUBLIC_CLERK_SIGN_UP_URL: /sign-up
      NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: /
      NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: /

      # Cloudflare R2 Storage (optional)
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID:-}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID:-}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY:-}
      R2_BUCKET_NAME: ${R2_BUCKET_NAME:-}
      R2_PUBLIC_URL: ${R2_PUBLIC_URL:-}

      # Upstash Redis (optional)
      UPSTASH_REDIS_REST_URL: ${UPSTASH_REDIS_REST_URL:-}
      UPSTASH_REDIS_REST_TOKEN: ${UPSTASH_REDIS_REST_TOKEN:-}

      # Notifications (optional)
      NOVU_API_KEY: ${NOVU_API_KEY:-}

      # App
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
      NEXT_PUBLIC_APP_NAME: ${NEXT_PUBLIC_APP_NAME:-QualyIT}
      NODE_ENV: production
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - qualyit-network
    labels:
      # Coolify labels for auto-discovery
      - "coolify.managed=true"
      - "coolify.type=application"

volumes:
  postgres_data:
    driver: local

networks:
  qualyit-network:
    driver: bridge
